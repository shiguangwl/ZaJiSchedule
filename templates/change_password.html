{% extends "base.html" %}

{% block title %}修改密码 - CPU 智能调度系统{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-key"></i> 修改密码
                </h5>
            </div>
            <div class="card-body">
                <!-- 成功提示 -->
                <div id="successAlert" class="alert alert-success d-none" role="alert">
                    <i class="fas fa-check-circle"></i> <span id="successMessage"></span>
                </div>

                <!-- 错误提示 -->
                <div id="errorAlert" class="alert alert-danger d-none" role="alert">
                    <i class="fas fa-exclamation-circle"></i> <span id="errorMessage"></span>
                </div>

                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="oldPassword" class="form-label">
                            <i class="fas fa-lock"></i> 当前密码
                        </label>
                        <input 
                            type="password" 
                            class="form-control" 
                            id="oldPassword" 
                            name="old_password"
                            required
                            autocomplete="current-password"
                        >
                    </div>

                    <div class="mb-3">
                        <label for="newPassword" class="form-label">
                            <i class="fas fa-lock"></i> 新密码
                        </label>
                        <input 
                            type="password" 
                            class="form-control" 
                            id="newPassword" 
                            name="new_password"
                            required
                            minlength="6"
                            autocomplete="new-password"
                        >
                        <div class="form-text">密码至少6个字符</div>
                    </div>

                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">
                            <i class="fas fa-lock"></i> 确认新密码
                        </label>
                        <input 
                            type="password" 
                            class="form-control" 
                            id="confirmPassword" 
                            name="confirm_password"
                            required
                            minlength="6"
                            autocomplete="new-password"
                        >
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 修改密码
                        </button>
                        <a href="/dashboard" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 返回
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 密码安全提示 -->
        <div class="card mt-3">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-info-circle text-info"></i> 密码安全建议
                </h6>
                <ul class="mb-0 small text-muted">
                    <li>密码长度至少6个字符</li>
                    <li>建议使用字母、数字和特殊字符的组合</li>
                    <li>不要使用过于简单的密码</li>
                    <li>定期更换密码以提高安全性</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const form = document.getElementById('changePasswordForm');
    const successAlert = document.getElementById('successAlert');
    const errorAlert = document.getElementById('errorAlert');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    // 隐藏提示
    function hideAlerts() {
        successAlert.classList.add('d-none');
        errorAlert.classList.add('d-none');
    }

    // 显示成功提示
    function showSuccess(message) {
        hideAlerts();
        successMessage.textContent = message;
        successAlert.classList.remove('d-none');
        
        // 3秒后跳转到仪表盘
        setTimeout(() => {
            window.location.href = '/dashboard';
        }, 3000);
    }

    // 显示错误提示
    function showError(message) {
        hideAlerts();
        errorMessage.textContent = message;
        errorAlert.classList.remove('d-none');
    }

    // 表单提交
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideAlerts();

        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // 前端验证
        if (newPassword.length < 6) {
            showError('新密码至少需要6个字符');
            return;
        }

        if (newPassword !== confirmPassword) {
            showError('两次输入的新密码不一致');
            return;
        }

        if (oldPassword === newPassword) {
            showError('新密码不能与当前密码相同');
            return;
        }

        // 提交到后端
        try {
            const response = await apiRequest('/api/auth/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    old_password: oldPassword,
                    new_password: newPassword
                })
            });

            if (response.ok) {
                const data = await response.json();
                showSuccess(data.message + ',即将跳转到仪表盘...');
                form.reset();
            } else {
                const error = await response.json();
                showError(error.detail || '密码修改失败');
            }
        } catch (error) {
            showError('网络错误,请稍后重试');
            console.error('修改密码错误:', error);
        }
    });

    // 实时验证确认密码
    document.getElementById('confirmPassword').addEventListener('input', function() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = this.value;
        
        if (confirmPassword && newPassword !== confirmPassword) {
            this.setCustomValidity('两次输入的密码不一致');
        } else {
            this.setCustomValidity('');
        }
    });
</script>
{% endblock %}

