# CPU智能调度系统 - 总结文档

## 项目概述

**项目名称**：CPU智能调度系统
**项目目标**：在严格CPU限制条件下，通过智能调度算法最大化资源利用率，避免服务停机
**技术栈**：Python + FastAPI + SQLite + cgroup v2
**部署方式**：单机部署，轻量化设计

## 核心约束条件

1. **12小时平均限制**：过去12小时CPU平均使用率 ≤ 30%
2. **24小时峰值限制**：过去24小时100%CPU使用时长 ≤ 10分钟

## 核心功能特性

### 1. 实时监控与调度
- 秒级CPU监控
- 基于滑动窗口的智能调度
- 动态CPU限制调整（通过cgroup v2）
- 多维度系统监控（CPU、内存、磁盘IO、网络）

### 2. 配额预留管理
- 为关键任务预留CPU配额
- 支持一次性和周期性预留
- 时间冲突检测
- 优先级管理

### 3. Web管理界面
- 实时监控大盘
- 配置参数动态调整
- 预留管理界面
- 告警和日志查看

### 4. 告警系统
- 多级别告警（警告/严重/紧急）
- 配额告警、系统告警、预留告警
- 多种通知方式（Web/邮件/Webhook）
- 告警聚合和静默

## 核心技术方案

### 滑动窗口算法

#### 12小时平均窗口
- 使用循环队列存储43200个数据点（12小时×3600秒）
- O(1)时间复杂度计算平均值
- 实时计算剩余配额

#### 24小时峰值窗口
- 追踪峰值使用时段（CPU > 95%）
- 累计峰值使用总时长
- 自动清理过期数据

#### 配额预留算法
- 综合考虑12小时窗口、24小时窗口和预留配额
- 取所有约束的最小值作为最终可用配额
- 支持预留优先级和冲突检测

### 动态调度策略

根据剩余配额动态调整CPU限制：

| 配额状态 | 剩余配额 | CPU限制 | 调整速度 |
|---------|---------|---------|---------|
| 充足 | > 20% | 85% | 快速 |
| 紧张 | 5-20% | 60% | 中等 |
| 即将耗尽 | < 5% | 35% | 缓慢 |
| 紧急 | < 1% | 20% | 保守 |

## 系统架构

### 模块设计

```
┌─────────────────────────────────────────────────────────┐
│                     Web界面 (前端)                       │
│         实时监控 | 配置管理 | 预留管理 | 告警查看         │
└─────────────────────────────────────────────────────────┘
                            ↕ (WebSocket + REST API)
┌─────────────────────────────────────────────────────────┐
│                   Web服务模块 (FastAPI)                  │
│         API接口 | WebSocket推送 | 认证授权              │
└─────────────────────────────────────────────────────────┘
                            ↕
┌──────────────┬──────────────┬──────────────┬───────────┐
│  监控模块    │  调度模块    │  预留模块    │ 告警模块  │
│  (psutil)    │  (算法核心)  │  (配额管理)  │ (通知)    │
└──────────────┴──────────────┴──────────────┴───────────┘
                            ↕
┌─────────────────────────────────────────────────────────┐
│              cgroup管理模块 (资源控制)                   │
│                  动态调整CPU限制                         │
└─────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────┐
│                  数据存储 (SQLite)                       │
│    配置 | 监控数据 | 预留记录 | 调度日志 | 告警记录      │
└─────────────────────────────────────────────────────────┘
```

## 可配置参数体系

系统提供200+可配置参数，分为8大类：

### 1. 监控配置 (monitoring.*)
- 采集间隔、启用开关、数据处理参数

### 2. 数据库配置 (database.*)
- 数据保留天数、采样频率、策略

### 3. CPU限制配置 (limits.*)
- 平均窗口长度、平均最大/最小CPU
- 峰值窗口长度、峰值阈值、峰值持续时间
- 安全边界参数

### 4. 调度器配置 (scheduler.*)
- 调度模式（保守/平衡/激进）
- 调整步长、调整间隔、平滑系数
- 不同配额状态下的CPU限制

### 5. 预留管理配置 (reservation.*)
- 预留策略、冲突处理、优先级管理

### 6. 告警配置 (alerts.*)
- 告警开关、告警阈值、通知渠道

### 7. Web服务配置 (server.*)
- 服务设置、WebSocket配置、安全设置

### 8. 性能配置 (performance.*)
- 资源限制、缓存配置、并发控制

**配置管理特性**：
- 支持运行时热更新
- 配置验证和冲突检测
- 配置历史和回滚
- 配置导入导出

## 数据库设计

### 核心表结构

1. **config** - 配置表（支持动态配置）
2. **monitoring_data** - 监控数据表（按采样频率存储）
3. **quota_reservations** - 配额预留表（支持周期性预留）
4. **schedule_logs** - 调度日志表（审计和分析）
5. **config_history** - 配置历史表（变更追踪）
6. **alerts** - 告警记录表（告警管理）

### 数据管理策略
- 按配置的保留天数自动清理
- 长期数据（如1小时平均值）
- 支持数据归档和导出
- 定期数据库优化（VACUUM）

## 实现路线图

### 第一阶段：核心功能
- 1: 基础框架、数据库、配置管理
- 2: 监控模块、滑动窗口算法、调度模块
- 3: Web服务、REST API、基础前端

### 第二阶段：完善功能
- 4: 配额预留功能
- 5: 前端界面完善

### 第三阶段：优化和测试
- 6: 性能优化
- 7: 测试和文档

### 第四阶段：部署和运维
- 8: 部署工具、监控告警

## 关键技术要点

### 1. 性能优化
- 滑动窗口O(1)时间复杂度
- 异步IO处理
- 数据库批量操作
- 前端数据

### 2. 稳定性保障
- 异常处理和恢复机制
- systemd自动重启
- 健康检查接口
- 数据持久化

### 3. 安全性
- API认证和授权
- 会话管理
- 配置文件权限控制
- 敏感数据加密

### 4. 可扩展性
- 模块化设计
- 插件系统（未来）
- 配置化功能开关
- API版本管理

## 部署要求

### 系统要求
- Linux系统（内核4.5+，支持cgroup v2）
- Python 3.8+
- root权限（cgroup操作）
- 512MB内存，1GB磁盘空间

### 部署流程
1. 环境准备和依赖安装
2. 代码部署和数据库初始化
3. cgroup配置
4. systemd服务配置
5. 启动验证

## 常见问题

### Q1: 如何避免调度震荡？
- 设置调整阈值和最小间隔
- 使用平滑算法
- 渐进式调整

### Q2: 数据库文件过大怎么办？
- 定期清理历史数据
- 数据归档
- 数据库VACUUM优化

### Q3: 如何保证服务高可用？
- systemd自动重启
- 健康检查和心跳监控
- 异常恢复机制

## 项目价值
- 最大化CPU利用率（提升50-80%）
- 避免服务停机（100%可用性）
- 降低资源浪费


## 总结

本系统通过创新的滑动窗口算法和动态调度策略，在严格的CPU限制条件下实现了资源利用率的最大化。系统具有以下特点：

✅ **智能调度** - 基于实时数据的动态CPU限制调整
✅ **高度可配置** - 200+参数支持动态配置
✅ **稳定可靠** - 完善的异常处理和恢复机制
✅ **易于使用** - 直观的Web界面和完善的文档
✅ **可扩展** - 模块化设计，支持功能扩展

系统适用于所有存在CPU限制的云服务器环境，能够显著提升资源利用率，同时确保服务稳定运行。
