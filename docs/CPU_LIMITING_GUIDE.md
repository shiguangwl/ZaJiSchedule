# CPU é™åˆ¶ä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
- [å·¥ä½œåŸç†](#å·¥ä½œåŸç†)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## æ¦‚è¿°

æœ¬ç³»ç»Ÿæä¾›äº†åŸºäº Linux cgroups v2 çš„è‡ªåŠ¨ CPU é™åˆ¶åŠŸèƒ½ï¼Œèƒ½å¤Ÿï¼š

- âœ… **è‡ªåŠ¨é™åˆ¶ CPU ä½¿ç”¨ç‡**ï¼šæ ¹æ®é…ç½®çš„é™åˆ¶è‡ªåŠ¨è°ƒæ•´ CPU é…é¢
- âœ… **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®å†å²æ•°æ®å’Œå½“å‰è´Ÿè½½æ™ºèƒ½è°ƒæ•´é™åˆ¶
- âœ… **é˜²æ­¢åœæœº**ï¼šç¡®ä¿å¹³å‡ CPU ä½¿ç”¨ç‡ä¸è¶…è¿‡é…ç½®çš„é™åˆ¶
- âœ… **æ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç **ï¼šé€šè¿‡ cgroups åœ¨ç³»ç»Ÿå±‚é¢é™åˆ¶ CPU

---

## ç³»ç»Ÿè¦æ±‚

### å¿…éœ€

- **æ“ä½œç³»ç»Ÿ**ï¼šLinuxï¼ˆæ”¯æŒ cgroups v2ï¼‰
- **æƒé™**ï¼šroot æƒé™
- **Python**ï¼š3.8 æˆ–æ›´é«˜ç‰ˆæœ¬
- **å†…æ ¸**ï¼šLinux 4.5+ ï¼ˆcgroups v2 æ”¯æŒï¼‰

### æ£€æŸ¥ cgroups v2 æ”¯æŒ

```bash
# æ£€æŸ¥æ˜¯å¦æ”¯æŒ cgroups v2
ls /sys/fs/cgroup/cgroup.controllers

# å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè¯´æ˜æ”¯æŒ cgroups v2
```

### å¯ç”¨ cgroups v2ï¼ˆå¦‚æœéœ€è¦ï¼‰

```bash
# åœ¨ /etc/default/grub ä¸­æ·»åŠ 
GRUB_CMDLINE_LINUX="systemd.unified_cgroup_hierarchy=1"

# æ›´æ–° grub å¹¶é‡å¯
sudo update-grub
sudo reboot
```

---

## å¿«é€Ÿå¼€å§‹

### æ–¹æ³• 1ï¼šä½¿ç”¨æ‰˜ç®¡å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. ç¡®ä¿è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
source .venv/bin/activate

# 2. ä½¿ç”¨ root æƒé™å¯åŠ¨
sudo .venv/bin/python start_managed.py
```

### æ–¹æ³• 2ï¼šä½¿ç”¨ Shell è„šæœ¬

```bash
# 1. ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x start_with_cpu_limit.sh

# 2. ä½¿ç”¨ root æƒé™å¯åŠ¨
sudo ./start_with_cpu_limit.sh
```

### æ–¹æ³• 3ï¼šæ‰‹åŠ¨å¯åŠ¨

```bash
# 1. å¯åŠ¨ä¸»åº”ç”¨
python main.py &
MAIN_PID=$!

# 2. å¯åŠ¨ CPU é™åˆ¶å™¨
sudo python cpu_limiter.py $MAIN_PID
```

---

## ä½¿ç”¨æ–¹æ³•

### 1. æ‰˜ç®¡å¯åŠ¨ï¼ˆæ¨èï¼‰

**ç‰¹ç‚¹**ï¼š
- è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç† cgroup
- è‡ªåŠ¨ç›‘æ§å’Œè°ƒæ•´ CPU é™åˆ¶
- ä¼˜é›…å…³é—­

**ä½¿ç”¨**ï¼š
```bash
sudo .venv/bin/python start_managed.py
```

**æ—¥å¿—**ï¼š
- ä¸»æ—¥å¿—ï¼š`logs/managed_start.log`
- åº”ç”¨æ—¥å¿—ï¼šåº”ç”¨è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º

**åœæ­¢**ï¼š
```bash
# æŒ‰ Ctrl+C æˆ–å‘é€ SIGTERM
sudo pkill -f start_managed.py
```

---

### 2. Shell è„šæœ¬å¯åŠ¨

**ç‰¹ç‚¹**ï¼š
- åˆ†ç¦»çš„ä¸»åº”ç”¨å’Œé™åˆ¶å™¨è¿›ç¨‹
- è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- è‡ªåŠ¨æ¸…ç†

**ä½¿ç”¨**ï¼š
```bash
sudo ./start_with_cpu_limit.sh
```

**æ—¥å¿—**ï¼š
- ä¸»åº”ç”¨æ—¥å¿—ï¼š`logs/main.log`
- é™åˆ¶å™¨æ—¥å¿—ï¼š`logs/cpu_limiter.log`

**åœæ­¢**ï¼š
```bash
# æŒ‰ Ctrl+C æˆ–å‘é€ SIGTERM
# è„šæœ¬ä¼šè‡ªåŠ¨æ¸…ç†æ‰€æœ‰è¿›ç¨‹å’Œ cgroup
```

---

### 3. æ‰‹åŠ¨å¯åŠ¨

**é€‚ç”¨åœºæ™¯**ï¼š
- è°ƒè¯•
- è‡ªå®šä¹‰é…ç½®
- é›†æˆåˆ°å…¶ä»–ç³»ç»Ÿ

**æ­¥éª¤**ï¼š

```bash
# 1. å¯åŠ¨ä¸»åº”ç”¨
python main.py &
MAIN_PID=$!
echo "ä¸»åº”ç”¨ PID: $MAIN_PID"

# 2. å¯åŠ¨ CPU é™åˆ¶å™¨
sudo python cpu_limiter.py $MAIN_PID

# 3. åœæ­¢ï¼ˆåœ¨å¦ä¸€ä¸ªç»ˆç«¯ï¼‰
sudo pkill -f cpu_limiter.py
kill $MAIN_PID
```

---

## å·¥ä½œåŸç†

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸»åº”ç”¨ (main.py)                      â”‚
â”‚  - é‡‡é›†ç³»ç»ŸæŒ‡æ ‡                                          â”‚
â”‚  - å­˜å‚¨åˆ°æ•°æ®åº“                                          â”‚
â”‚  - æä¾› Web ç•Œé¢                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ ç›‘æ§
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CPU è°ƒåº¦å™¨ (CPUScheduler)                   â”‚
â”‚  - è®¡ç®—æ»šåŠ¨çª—å£å¹³å‡ CPU                                  â”‚
â”‚  - è®¡ç®—å‰©ä½™é…é¢                                          â”‚
â”‚  - è®¡ç®—å®‰å…¨ CPU é™åˆ¶                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ å»ºè®®é™åˆ¶
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CPU é™åˆ¶å™¨ (CGroupCPULimiter)                  â”‚
â”‚  - åˆ›å»ºå’Œç®¡ç† cgroup                                     â”‚
â”‚  - è®¾ç½® CPU é…é¢                                         â”‚
â”‚  - åŠ¨æ€è°ƒæ•´é™åˆ¶                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ åº”ç”¨é™åˆ¶
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Linux cgroups v2                          â”‚
â”‚  - å†…æ ¸çº§ CPU é™åˆ¶                                       â”‚
â”‚  - ç¡¬é™åˆ¶ï¼Œæ— æ³•ç»•è¿‡                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é™åˆ¶ç­–ç•¥

1. **æ»šåŠ¨çª—å£è®¡ç®—**ï¼š
   - çª—å£å¤§å°ï¼š24 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
   - è®¡ç®—å®é™…è¿è¡Œæ—¶é•¿
   - è®¡ç®—å·²ç”¨é…é¢å’Œå‰©ä½™é…é¢

2. **ç›®æ ‡ CPU è®¡ç®—**ï¼š
   ```
   å‰©ä½™é…é¢ = æ€»é…é¢ - å·²ç”¨é…é¢
   å‰©ä½™æ—¶é—´ = çª—å£æ—¶é•¿ - å®é™…è¿è¡Œæ—¶é•¿
   ç›®æ ‡ CPU = å‰©ä½™é…é¢ / å‰©ä½™æ—¶é—´
   ```

3. **å®‰å…¨é™åˆ¶è®¡ç®—**ï¼š
   ```
   å®‰å…¨é™åˆ¶ = ç›®æ ‡ CPU Ã— å®‰å…¨ç³»æ•° (0.9)
   ```

4. **cgroup é™åˆ¶**ï¼š
   ```
   CPU é…é¢ = å®‰å…¨é™åˆ¶ Ã— å‘¨æœŸ (100ms)
   ```

### ç¤ºä¾‹

**é…ç½®**ï¼š
- çª—å£æ—¶é•¿ï¼š24 å°æ—¶
- å¹³å‡é™åˆ¶ï¼š30%
- å®‰å…¨ç³»æ•°ï¼š0.9

**è¿è¡Œ 1 å°æ—¶å**ï¼š
```
å®é™…è¿è¡Œæ—¶é•¿: 1 å°æ—¶
å¹³å‡ CPU: 36.5%
å·²ç”¨é…é¢: 36.5% Ã— 1h = 36.5 %Â·h
æ€»é…é¢: 30% Ã— 24h = 720 %Â·h
å‰©ä½™é…é¢: 720 - 36.5 = 683.5 %Â·h
å‰©ä½™æ—¶é—´: 24 - 1 = 23 å°æ—¶
ç›®æ ‡ CPU: 683.5 / 23 = 29.7%
å®‰å…¨é™åˆ¶: 29.7% Ã— 0.9 = 26.7%
```

**cgroup è®¾ç½®**ï¼š
```
cpu.max = "26700 100000"
```

è¿™æ„å‘³ç€ï¼šåœ¨æ¯ 100ms çš„å‘¨æœŸå†…ï¼Œè¿›ç¨‹æœ€å¤šå¯ä»¥ä½¿ç”¨ 26.7ms çš„ CPU æ—¶é—´ã€‚

---

## é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶ï¼š`config.py`

```python
class Config:
    # æ»šåŠ¨çª—å£æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
    rolling_window_hours: int = 24
    
    # å¹³å‡è´Ÿè½½é™åˆ¶ï¼ˆç™¾åˆ†æ¯”ï¼‰
    avg_load_limit_percent: float = 30.0
    
    # å®‰å…¨ç³»æ•°ï¼ˆ0-1ï¼‰
    safety_factor: float = 0.9
    
    # æŒ‡æ ‡é‡‡é›†é—´éš”ï¼ˆç§’ï¼‰
    metrics_interval_seconds: int = 5
```

### æ•°æ®åº“é…ç½®

é…ç½®å­˜å‚¨åœ¨ SQLite æ•°æ®åº“ä¸­ï¼Œå¯ä»¥é€šè¿‡ Web ç•Œé¢æˆ– API ä¿®æ”¹ï¼š

```bash
# æŸ¥çœ‹å½“å‰é…ç½®
sqlite3 scheduler.db "SELECT * FROM system_config;"

# ä¿®æ”¹é…ç½®
sqlite3 scheduler.db "UPDATE system_config SET value='30' WHERE key='avg_load_limit_percent';"
```

---

## æ•…éšœæ’é™¤

### 1. æƒé™é”™è¯¯

**é”™è¯¯**ï¼š
```
PermissionError: éœ€è¦ root æƒé™æ¥ç®¡ç† cgroups
```

**è§£å†³**ï¼š
```bash
# ä½¿ç”¨ sudo è¿è¡Œ
sudo python start_managed.py
```

---

### 2. cgroups v2 ä¸æ”¯æŒ

**é”™è¯¯**ï¼š
```
RuntimeError: ç³»ç»Ÿä¸æ”¯æŒ cgroups v2
```

**æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥ cgroups ç‰ˆæœ¬
mount | grep cgroup

# å¦‚æœçœ‹åˆ° cgroup2ï¼Œè¯´æ˜æ”¯æŒ v2
# å¦‚æœåªçœ‹åˆ° cgroupï¼Œè¯´æ˜ä½¿ç”¨çš„æ˜¯ v1
```

**è§£å†³**ï¼š
```bash
# åœ¨ /etc/default/grub ä¸­æ·»åŠ 
GRUB_CMDLINE_LINUX="systemd.unified_cgroup_hierarchy=1"

# æ›´æ–°å¹¶é‡å¯
sudo update-grub
sudo reboot
```

---

### 3. è¿›ç¨‹æœªè¢«é™åˆ¶

**æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹ cgroup ä¸­çš„è¿›ç¨‹
cat /sys/fs/cgroup/zajischedule/cgroup.procs

# æŸ¥çœ‹ CPU é™åˆ¶
cat /sys/fs/cgroup/zajischedule/cpu.max
```

**éªŒè¯**ï¼š
```bash
# æŸ¥çœ‹è¿›ç¨‹çš„ cgroup
cat /proc/<PID>/cgroup

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# 0::/zajischedule
```

---

### 4. CPU é™åˆ¶ä¸ç”Ÿæ•ˆ

**å¯èƒ½åŸå› **ï¼š
1. è¿›ç¨‹ä¸åœ¨ cgroup ä¸­
2. CPU é™åˆ¶è®¾ç½®é”™è¯¯
3. ç³»ç»Ÿè´Ÿè½½è¿‡ä½ï¼Œæœªè¾¾åˆ°é™åˆ¶

**è°ƒè¯•**ï¼š
```bash
# æŸ¥çœ‹å®æ—¶ CPU ä½¿ç”¨
top -p <PID>

# æŸ¥çœ‹ cgroup ç»Ÿè®¡
cat /sys/fs/cgroup/zajischedule/cpu.stat
```

---

### 5. åº”ç”¨å¯åŠ¨å¤±è´¥

**æ£€æŸ¥æ—¥å¿—**ï¼š
```bash
# æ‰˜ç®¡å¯åŠ¨æ—¥å¿—
tail -f logs/managed_start.log

# Shell è„šæœ¬æ—¥å¿—
tail -f logs/main.log
tail -f logs/cpu_limiter.log
```

**å¸¸è§é—®é¢˜**ï¼š
- Python è·¯å¾„é”™è¯¯
- è™šæ‹Ÿç¯å¢ƒæœªæ¿€æ´»
- ä¾èµ–åŒ…æœªå®‰è£…

---

## é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰ cgroup åç§°

```python
# åœ¨ cpu_limiter.py ä¸­
limiter = CGroupCPULimiter(cgroup_name="my_custom_cgroup")
```

### è°ƒæ•´æ›´æ–°é—´éš”

```python
# åœ¨ start_managed.py ä¸­
dynamic_scheduler = DynamicCPUScheduler(
    limiter, 
    scheduler, 
    config,
    update_interval=5  # 5 ç§’æ›´æ–°ä¸€æ¬¡
)
```

### é›†æˆåˆ° systemd

åˆ›å»º `/etc/systemd/system/zajischedule.service`ï¼š

```ini
[Unit]
Description=ZaJi Schedule with CPU Limiting
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/path/to/ZaJiSchedule
ExecStart=/path/to/.venv/bin/python start_managed.py
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl enable zajischedule
sudo systemctl start zajischedule
sudo systemctl status zajischedule
```

---

## ç›‘æ§å’Œæ—¥å¿—

### å®æ—¶ç›‘æ§

```bash
# æŸ¥çœ‹ CPU ä½¿ç”¨ç‡
watch -n 1 'cat /sys/fs/cgroup/zajischedule/cpu.stat'

# æŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨
watch -n 1 'cat /sys/fs/cgroup/zajischedule/cgroup.procs'

# æŸ¥çœ‹ CPU é™åˆ¶
watch -n 1 'cat /sys/fs/cgroup/zajischedule/cpu.max'
```

### æ—¥å¿—ä½ç½®

- **æ‰˜ç®¡å¯åŠ¨**ï¼š`logs/managed_start.log`
- **ä¸»åº”ç”¨**ï¼š`logs/main.log`
- **CPU é™åˆ¶å™¨**ï¼š`logs/cpu_limiter.log`

---

## æ€§èƒ½å½±å“

### CPU å¼€é”€

- **ç›‘æ§å¼€é”€**ï¼š< 0.1% CPU
- **cgroup å¼€é”€**ï¼š< 0.05% CPU
- **æ€»å¼€é”€**ï¼š< 0.2% CPU

### å†…å­˜å¼€é”€

- **Python è¿›ç¨‹**ï¼š~50MB
- **cgroup**ï¼š< 1MB
- **æ€»å¼€é”€**ï¼š~51MB

---

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **root æƒé™**ï¼š
   - ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨ root æƒé™
   - è€ƒè™‘ä½¿ç”¨ sudo é…ç½®é™åˆ¶æƒé™

2. **cgroup éš”ç¦»**ï¼š
   - ä½¿ç”¨ç‹¬ç«‹çš„ cgroup åç§°
   - é¿å…å½±å“å…¶ä»–è¿›ç¨‹

3. **èµ„æºé™åˆ¶**ï¼š
   - è®¾ç½®åˆç†çš„ CPU é™åˆ¶
   - é¿å…è¿‡åº¦é™åˆ¶å¯¼è‡´æœåŠ¡ä¸å¯ç”¨

---

## æ€»ç»“

æœ¬ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„ CPU é™åˆ¶è§£å†³æ–¹æ¡ˆï¼š

- âœ… **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€æ‰‹åŠ¨å¹²é¢„
- âœ… **æ™ºèƒ½**ï¼šåŸºäºå†å²æ•°æ®åŠ¨æ€è°ƒæ•´
- âœ… **å¯é **ï¼šå†…æ ¸çº§é™åˆ¶ï¼Œæ— æ³•ç»•è¿‡
- âœ… **çµæ´»**ï¼šæ”¯æŒå¤šç§å¯åŠ¨æ–¹å¼
- âœ… **å¯ç›‘æ§**ï¼šè¯¦ç»†çš„æ—¥å¿—å’ŒçŠ¶æ€ä¿¡æ¯

é€šè¿‡åˆç†é…ç½®å’Œä½¿ç”¨ï¼Œå¯ä»¥ç¡®ä¿åº”ç”¨ç¨‹åºæ°¸è¿œä¸ä¼šå›  CPU ä½¿ç”¨è¶…é™è€Œè¢«åœæœºã€‚

